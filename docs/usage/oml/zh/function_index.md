# OML Pipe Functions å‡½æ•°ç´¢å¼•

æœ¬æ–‡æ¡£åˆ—å‡ºäº† WP-Motor OML è¯­è¨€ä¸­æ‰€æœ‰å¯ç”¨çš„ pipe functionï¼ˆç®¡é“å‡½æ•°ï¼‰ã€‚

## å­—æ®µè®¿é—®å‡½æ•° (Field Accessors)

| å‡½æ•° | è¯­æ³• | è¯´æ˜ | æ–‡æ¡£ |
|------|------|------|------|
| `take` | `take(field_name)` | ä»è¾“å…¥æ•°æ®ä¸­æå–æŒ‡å®šå­—æ®µ | - |
| `get` | `get(key)` | ä»åµŒå¥—ç»“æ„ä¸­è·å–æŒ‡å®šé”®çš„å€¼ | - |
| `nth` | `nth(index)` | ä»æ•°ç»„ä¸­è·å–æŒ‡å®šç´¢å¼•çš„å…ƒç´  | - |

## å­—ç¬¦ä¸²åŒ¹é…å‡½æ•° (String Matching)

| å‡½æ•° | è¯­æ³• | è¯´æ˜ | æ–‡æ¡£ |
|------|------|------|------|
| `starts_with` | `starts_with('prefix')` | æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦ä»¥æŒ‡å®šå‰ç¼€å¼€å§‹ï¼Œå¦åˆ™è½¬ä¸º ignore | [ğŸ“– è¯¦ç»†æ–‡æ¡£](./starts_with.md) |

## å€¼è½¬æ¢å‡½æ•° (Value Transformation)

| å‡½æ•° | è¯­æ³• | è¯´æ˜ | æ–‡æ¡£ |
|------|------|------|------|
| `map_to` | `map_to(value)` | å°†é ignore å­—æ®µæ˜ å°„åˆ°æŒ‡å®šå€¼ï¼ˆæ”¯æŒå¤šç§ç±»å‹ï¼‰ | [ğŸ“– è¯¦ç»†æ–‡æ¡£](./map_to.md) |
| `to_str` | `to_str` | å°†å­—æ®µå€¼è½¬æ¢ä¸ºå­—ç¬¦ä¸² | - |
| `to_json` | `to_json` | å°†å­—æ®µå€¼è½¬æ¢ä¸º JSON å­—ç¬¦ä¸² | - |

## ç¼–ç /è§£ç å‡½æ•° (Encoding/Decoding)

| å‡½æ•° | è¯­æ³• | è¯´æ˜ | æ–‡æ¡£ |
|------|------|------|------|
| `base64_encode` | `base64_encode` | Base64 ç¼–ç å­—ç¬¦ä¸² | - |
| `base64_decode` | `base64_decode(encoding)` | Base64 è§£ç å­—ç¬¦ä¸²ï¼ˆå¯æŒ‡å®šç¼–ç ï¼‰ | - |
| `html_escape` | `html_escape` | HTML è½¬ä¹‰å­—ç¬¦ä¸² | - |
| `html_unescape` | `html_unescape` | HTML åè½¬ä¹‰å­—ç¬¦ä¸² | - |
| `json_escape` | `json_escape` | JSON è½¬ä¹‰å­—ç¬¦ä¸² | - |
| `json_unescape` | `json_unescape` | JSON åè½¬ä¹‰å­—ç¬¦ä¸² | - |
| `str_escape` | `str_escape` | é€šç”¨å­—ç¬¦ä¸²è½¬ä¹‰ | - |

## æ—¶é—´è½¬æ¢å‡½æ•° (Time Conversion)

| å‡½æ•° | è¯­æ³• | è¯´æ˜ | æ–‡æ¡£ |
|------|------|------|------|
| `Time::to_ts` | `Time::to_ts` | å°†æ—¶é—´è½¬æ¢ä¸ºç§’çº§æ—¶é—´æˆ³ | - |
| `Time::to_ts_ms` | `Time::to_ts_ms` | å°†æ—¶é—´è½¬æ¢ä¸ºæ¯«ç§’çº§æ—¶é—´æˆ³ | - |
| `Time::to_ts_us` | `Time::to_ts_us` | å°†æ—¶é—´è½¬æ¢ä¸ºå¾®ç§’çº§æ—¶é—´æˆ³ | - |
| `Time::to_ts_zone` | `Time::to_ts_zone(zone, unit)` | å°†æ—¶é—´è½¬æ¢ä¸ºæŒ‡å®šæ—¶åŒºçš„æ—¶é—´æˆ³ | - |

## ç½‘ç»œå‡½æ•° (Network)

| å‡½æ•° | è¯­æ³• | è¯´æ˜ | æ–‡æ¡£ |
|------|------|------|------|
| `ip4_to_int` | `ip4_to_int` | å°† IPv4 åœ°å€è½¬æ¢ä¸ºæ•´æ•° | - |

## URL/è·¯å¾„è§£æå‡½æ•° (URL/Path Parsing)

| å‡½æ•° | è¯­æ³• | è¯´æ˜ | æ–‡æ¡£ |
|------|------|------|------|
| `path` | `path(type)` | ä»è·¯å¾„å­—ç¬¦ä¸²ä¸­æå–æŒ‡å®šéƒ¨åˆ† | - |
| `url` | `url(type)` | ä» URL å­—ç¬¦ä¸²ä¸­æå–æŒ‡å®šéƒ¨åˆ† | - |

## æ§åˆ¶æµå‡½æ•° (Control Flow)

| å‡½æ•° | è¯­æ³• | è¯´æ˜ | æ–‡æ¡£ |
|------|------|------|------|
| `skip_empty` | `skip_empty` | è·³è¿‡ç©ºå€¼å­—æ®µ | - |

## å‡½æ•°åˆ†ç±»æ€»è§ˆ

### æŒ‰åŠŸèƒ½åˆ†ç±»

#### 1. æ•°æ®æå–å‡½æ•°
ä»è¾“å…¥æ•°æ®æˆ–åµŒå¥—ç»“æ„ä¸­æå–å­—æ®µã€‚

- `take(field)`: æå–é¡¶å±‚å­—æ®µ
- `get(key)`: æå–åµŒå¥—å­—æ®µ
- `nth(index)`: æå–æ•°ç»„å…ƒç´ 

#### 2. æ¡ä»¶è¿‡æ»¤å‡½æ•°
æ£€æŸ¥æ¡ä»¶ï¼Œä¸æ»¡è¶³æ—¶è½¬æ¢ä¸º ignoreã€‚

- `starts_with(prefix)`: å‰ç¼€åŒ¹é…

#### 3. å€¼æ˜ å°„å‡½æ•°
ä¿®æ”¹å­—æ®µå€¼æˆ–ç±»å‹ã€‚

- `map_to(value)`: é€šç”¨å€¼æ˜ å°„
- `to_str`: è½¬å­—ç¬¦ä¸²
- `to_json`: è½¬ JSON

#### 4. ç¼–ç è½¬æ¢å‡½æ•°
åœ¨ä¸åŒç¼–ç æ ¼å¼ä¹‹é—´è½¬æ¢ã€‚

- Base64: `base64_encode`, `base64_decode`
- HTML: `html_escape`, `html_unescape`
- JSON: `json_escape`, `json_unescape`

#### 5. æ—¶é—´å¤„ç†å‡½æ•°
å¤„ç†æ—¶é—´ç›¸å…³çš„è½¬æ¢ã€‚

- æ—¶é—´æˆ³è½¬æ¢: `Time::to_ts*`
- æ—¶åŒºè½¬æ¢: `Time::to_ts_zone`

#### 6. ç½‘ç»œå¤„ç†å‡½æ•°
å¤„ç†ç½‘ç»œç›¸å…³æ•°æ®ã€‚

- IP åœ°å€: `ip4_to_int`
- URL è§£æ: `url(type)`
- è·¯å¾„è§£æ: `path(type)`

## ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ç®¡é“

```oml
name : basic_pipeline
---
# 1. æå–å­—æ®µ
result = pipe take(message)
    # 2. è¿‡æ»¤æ¡ä»¶
    | starts_with('ERROR')
    # 3. å€¼æ˜ å°„
    | map_to('error_type');
```

### å¤æ‚è½¬æ¢

```oml
name : complex_transformation
---
# æå–å¹¶è½¬æ¢æ—¶é—´
timestamp_ms = pipe take(time_str)
    | Time::to_ts_ms;

# Base64 ç¼–ç 
encoded = pipe take(message)
    | base64_encode;

# URL è§£æ
host = pipe take(url)
    | url(host);
```

### æ¡ä»¶åˆ†ç±»

```oml
name : conditional_classification
---
# æ ¹æ® URL å‰ç¼€åˆ†ç±»å®‰å…¨çº§åˆ«
high_security = pipe take(url)
    | starts_with('https://')
    | map_to(3);

low_security = pipe take(url)
    | starts_with('http://')
    | map_to(1);
```

### æ•°æ®æ¸…æ´—

```oml
name : data_cleaning
---
# æå–å¹¶æ¸…ç†æ•°æ®
clean_message = pipe take(raw_message)
    | html_unescape
    | json_unescape
    | skip_empty;
```

## æ€§èƒ½å‚è€ƒ

| å‡½æ•°ç±»å‹ | å…¸å‹æ€§èƒ½ | è¯´æ˜ |
|----------|----------|------|
| å­—æ®µè®¿é—® | < 100ns | åŸºäºå“ˆå¸Œè¡¨æŸ¥æ‰¾ |
| å­—ç¬¦ä¸²åŒ¹é… | < 1Î¼s | ç®€å•å‰ç¼€æ¯”è¾ƒ |
| å€¼æ˜ å°„ | < 100ns | ç›´æ¥å€¼æ›¿æ¢ |
| Base64 ç¼–ç  | 1-10Î¼s | å–å†³äºå­—ç¬¦ä¸²é•¿åº¦ |
| æ—¶é—´è½¬æ¢ | 1-5Î¼s | æ—¶é—´è§£æå’Œè½¬æ¢ |
| URL è§£æ | 1-10Î¼s | URL ç»“æ„è§£æ |

## æœ€ä½³å®è·µ

### 1. åˆç†ä½¿ç”¨ç®¡é“é“¾

```oml
# âœ… æ¨èï¼šæŒ‰é€»è¾‘é¡ºåºç»„ç»‡ç®¡é“
result = pipe take(field)
    | starts_with('prefix')  # å…ˆè¿‡æ»¤
    | map_to('value');      # å†æ˜ å°„

# âš ï¸ é¿å…ï¼šä¸å¿…è¦çš„é•¿ç®¡é“
result = pipe take(field)
    | to_str
    | to_json
    | to_str  # å†—ä½™æ“ä½œ
```

### 2. åˆ©ç”¨ ignore ä¼ æ’­

```oml
# âœ… æ¨èï¼šåˆ©ç”¨ ignore è·³è¿‡åç»­å¤„ç†
secure_flag = pipe take(url)
    | starts_with('https://')  # å¤±è´¥è¿”å› ignore
    | map_to(true);           # ignore ä¼šè·³è¿‡æ­¤æ­¥

# è¿™æ ·å¯ä»¥å®‰å…¨åœ°å¤„ç†æ¡ä»¶é€»è¾‘
```

### 3. é€‰æ‹©åˆé€‚çš„å‡½æ•°

```oml
# âœ… æ¨èï¼šä½¿ç”¨ä¸“ç”¨å‡½æ•°
result = pipe take(field) | map_to(123);  # è‡ªåŠ¨æ¨æ–­ä¸ºæ•´æ•°

# âš ï¸ ä¸æ¨èï¼šæ‰‹åŠ¨è½¬æ¢
result = pipe take(field) | to_str | map_to('123');  # é¢å¤–å¼€é”€
```

### 4. é¿å…é‡å¤æå–

```oml
# âœ… æ¨èï¼šä¸€æ¬¡æå–ï¼Œå¤šæ¬¡ä½¿ç”¨
url_field = pipe take(url);
host = pipe take(url) | url(host);
path = pipe take(url) | url(path);

# âš ï¸ é¿å…ï¼šæ¯æ¬¡éƒ½æå–åŒä¸€å­—æ®µï¼ˆæ€§èƒ½å½±å“å°ä½†ä¸å¤Ÿæ¸…æ™°ï¼‰
```

## å‡½æ•°å¯¹æ¯”

### starts_with vs æ­£åˆ™è¡¨è¾¾å¼

| ç‰¹æ€§ | starts_with | æ­£åˆ™è¡¨è¾¾å¼ |
|------|------------|------------|
| æ€§èƒ½ | æå¿« | è¾ƒæ…¢ |
| åŠŸèƒ½ | å‰ç¼€åŒ¹é… | å¤æ‚æ¨¡å¼ |
| ä½¿ç”¨éš¾åº¦ | ç®€å• | éœ€è¦å­¦ä¹  |
| å¤±è´¥è¡Œä¸º | è½¬ä¸º ignore | - |

### map_to vs to_str

| ç‰¹æ€§ | map_to | to_str |
|------|--------|--------|
| åŠŸèƒ½ | å€¼æ›¿æ¢ | ç±»å‹è½¬æ¢ |
| ç±»å‹æ”¯æŒ | å¤šç§ | ä»…å­—ç¬¦ä¸² |
| ignore ä¿ç•™ | æ˜¯ | å¦ |
| ç”¨é€” | æ¡ä»¶èµ‹å€¼ | ç±»å‹è½¬æ¢ |

## ç›¸å…³æ–‡æ¡£

- **å¼€å‘æŒ‡å—**: [OML Pipe Function å¼€å‘æŒ‡å—](../../guide/oml_pipefun_development_guide.md)
- **è¯­æ³•å‚è€ƒ**: [OML è¯­æ³•æŒ‡å—](../../syntax/oml_syntax.md)

## ç‰ˆæœ¬å†å²

- **1.13.4** (2026-02-03)
  - æ–°å¢ `starts_with` å‡½æ•°
  - æ–°å¢ `map_to` å‡½æ•°ï¼Œæ”¯æŒå¤šç§ç±»å‹è‡ªåŠ¨æ¨æ–­
  - å®Œå–„æ–‡æ¡£ä½“ç³»

- **1.13.3** (2026-02-03)
  - ä¿®å¤ç¼–è¯‘é”™è¯¯

- **1.13.2** (2026-02-03)
  - å®Œå–„ pipe å‡½æ•°æ”¯æŒ

---

**æç¤º**: OML pipe å‡½æ•°è®¾è®¡ç”¨äºæ•°æ®è½¬æ¢å’Œæ˜ å°„ã€‚åˆç†ä½¿ç”¨ ignore æœºåˆ¶å¯ä»¥å®ç°çµæ´»çš„æ¡ä»¶é€»è¾‘ã€‚
