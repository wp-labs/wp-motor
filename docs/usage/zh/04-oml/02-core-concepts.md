# OML æ ¸å¿ƒæ¦‚å¿µ

æœ¬æ–‡æ¡£ä»‹ç» OML çš„æ ¸å¿ƒè®¾è®¡ç†å¿µå’ŒåŸºç¡€æ¦‚å¿µï¼Œå¸®åŠ©ä½ æ·±å…¥ç†è§£ OML çš„å·¥ä½œåŸç†ã€‚

---

## ğŸ“š æ–‡æ¡£å¯¼èˆª

### å¿«é€Ÿå¯¼èˆª

| ä¸»é¢˜ | å†…å®¹ |
|------|------|
| [**è®¾è®¡ç†å¿µ**](#oml-è®¾è®¡ç†å¿µ) | WPL åä½œå…³ç³»ã€å£°æ˜å¼è¯­æ³•ã€ä¸å¯å˜æ•°æ®æµ |
| [**ç±»å‹ç³»ç»Ÿ**](#ç±»å‹ç³»ç»Ÿ) | 8 ç§åŸºæœ¬ç±»å‹ã€è‡ªåŠ¨æ¨æ–­ã€ç±»å‹è½¬æ¢ |
| [**è¯»å–è¯­ä¹‰**](#è¯»å–è¯­ä¹‰read-vs-take) | read vs takeã€ç ´åæ€§ä¸éç ´åæ€§ã€è¯»å–ä¼˜å…ˆçº§ |
| [**è¡¨è¾¾å¼ç±»å‹**](#è¡¨è¾¾å¼ç±»å‹) | å€¼è¡¨è¾¾å¼ã€å‡½æ•°è°ƒç”¨ã€ç®¡é“ã€æ¡ä»¶ã€èšåˆ |
| [**é»˜è®¤å€¼æœºåˆ¶**](#é»˜è®¤å€¼æœºåˆ¶) | é»˜è®¤å€¼è¯­æ³•ã€å‡½æ•°é»˜è®¤å€¼ã€é™åˆ¶è¯´æ˜ |
| [**é€šé…ç¬¦**](#é€šé…ç¬¦ä¸æ‰¹é‡å¤„ç†) | é€šé…ç¬¦è¯­æ³•ã€æ‰¹é‡ç›®æ ‡ã€ä½¿ç”¨é™åˆ¶ |
| [**å‚æ•°åŒ–è¯»å–**](#å‚æ•°åŒ–è¯»å–) | option ä¼˜å…ˆçº§ã€keys æ”¶é›†ã€JSON è·¯å¾„ |
| [**è¡¨è¾¾å¼ç»„åˆ**](#è¡¨è¾¾å¼ç»„åˆ) | åµŒå¥—å¯¹è±¡ã€ç®¡é“é“¾ã€å¤æ‚ match |
| [**ä½œç”¨åŸŸè§„åˆ™**](#ä½œç”¨åŸŸè§„åˆ™) | ç›®æ ‡å­—æ®µä½œç”¨åŸŸã€å…¨å±€å­—æ®µ |
| [**æœ€ä½³å®è·µ**](#æœ€ä½³å®è·µ) | è¯»å–æ¨¡å¼é€‰æ‹©ã€ç±»å‹å£°æ˜ã€é»˜è®¤å€¼ã€é€šé…ç¬¦ä½¿ç”¨ |

---

## OML è®¾è®¡ç†å¿µ

### WPL ä¸ OML çš„åä½œå…³ç³»

OML ä¸æ˜¯ç‹¬ç«‹å·¥ä½œçš„ï¼Œå®ƒä¸ WPL ç´§å¯†é…åˆï¼š

```
1. WPL è§£æåŸå§‹æ•°æ®
   â†“
2. ç”Ÿæˆç»“æ„åŒ–æ•°æ® + rule æ ‡è¯†ï¼ˆå¦‚ /nginx/access_logï¼‰
   â†“
3. ç³»ç»ŸæŸ¥æ‰¾åŒ¹é…çš„ OML é…ç½®ï¼ˆé€šè¿‡ rule å­—æ®µï¼‰
   â†“
4. æ‰§è¡Œ OML è½¬æ¢
   â†“
5. è¾“å‡ºåˆ° Sink
```

**å…³é”®ç‚¹**ï¼š
- æ¯ä¸ª OML é…ç½®é€šè¿‡ `rule` å­—æ®µå£°æ˜å®ƒå¤„ç†å“ªäº› WPL è§„åˆ™çš„æ•°æ®
- ä¸€ä¸ª WPL è§„åˆ™å¯ä»¥å¯¹åº”å¤šä¸ª OML é…ç½®
- æ”¯æŒé€šé…ç¬¦åŒ¹é…ï¼Œå¦‚ `rule : /nginx/*` åŒ¹é…æ‰€æœ‰ nginx ç›¸å…³è§„åˆ™

**ç¤ºä¾‹**ï¼š
```oml
name : nginx_access_handler
rule : /nginx/access_log    # åªå¤„ç†è¿™ä¸ª WPL è§„åˆ™çš„æ•°æ®
---
# è½¬æ¢é€»è¾‘...
```

### å£°æ˜å¼è€Œéå‘½ä»¤å¼

OML é‡‡ç”¨å£°æ˜å¼è¯­æ³•ï¼Œä½ åªéœ€è¦æè¿°**æƒ³è¦ä»€ä¹ˆç»“æœ**ï¼Œè€Œä¸æ˜¯**å¦‚ä½•å®ç°**ï¼š

```oml
# å£°æ˜å¼ï¼šæè¿°ç»“æœ
user_info : obj = object {
    id : chars = read(user_id) ;
    name : chars = read(username) ;
} ;
```

å¯¹æ¯”å‘½ä»¤å¼ä¼ªä»£ç ï¼š
```
user_info = new Object()
user_info.id = get_field("user_id")
user_info.name = get_field("username")
convert_to_chars(user_info.id)
convert_to_chars(user_info.name)
```

### ä¸å¯å˜æ•°æ®æµ

OML ä¸­çš„æ•°æ®è½¬æ¢æ˜¯å•å‘æµåŠ¨çš„ï¼š

```
è¾“å…¥æ•°æ® â†’ OML è½¬æ¢ â†’ è¾“å‡ºæ•°æ®
```

- è¾“å…¥æ•°æ®ä¸ä¼šè¢«ä¿®æ”¹ï¼ˆé™¤éä½¿ç”¨ `take`ï¼‰
- æ¯ä¸ªè½¬æ¢æ­¥éª¤éƒ½äº§ç”Ÿæ–°çš„å€¼
- ä¾¿äºç†è§£å’Œè°ƒè¯•

## ç±»å‹ç³»ç»Ÿ

### åŸºæœ¬ç±»å‹

OML æä¾› 8 ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼š

```oml
name : types_example
---
# å­—ç¬¦ä¸²
text : chars = chars(hello) ;

# æ•´æ•°
count : digit = digit(42) ;

# æµ®ç‚¹æ•°
ratio : float = float(3.14) ;

# IP åœ°å€
address : ip = ip(192.168.1.1) ;

# æ—¶é—´
timestamp : time = Now::time() ;

# å¸ƒå°”å€¼
flag : bool = bool(true) ;

# å¯¹è±¡
info : obj = object { ... } ;

# æ•°ç»„
items : array = collect read(keys:[...]) ;
```

### è‡ªåŠ¨ç±»å‹æ¨æ–­

å½“ä¸æŒ‡å®šç±»å‹æ—¶ï¼ŒOML ä¼šè‡ªåŠ¨æ¨æ–­ï¼š

```oml
name : auto_type
---
# è‡ªåŠ¨æ¨æ–­ä¸º chars
name = read(name) ;

# è‡ªåŠ¨æ¨æ–­ä¸º digit
count = digit(100) ;

# æ˜¾å¼æŒ‡å®šç±»å‹ï¼ˆæ¨èï¼‰
port : digit = read(port) ;
```

**æœ€ä½³å®è·µ**ï¼šå¯¹äºé‡è¦å­—æ®µï¼Œå»ºè®®æ˜¾å¼å£°æ˜ç±»å‹ä»¥é¿å…æ„å¤–ã€‚

### ç±»å‹è½¬æ¢

OML ä¼šåœ¨å¿…è¦æ—¶è‡ªåŠ¨è¿›è¡Œç±»å‹è½¬æ¢ï¼š

```oml
name : type_cast
---
# ä»å­—ç¬¦ä¸² "8080" è½¬æ¢ä¸ºæ•´æ•° 8080
port : digit = read(port) ;

# ä»å­—ç¬¦ä¸² "192.168.1.1" è½¬æ¢ä¸º IP
ip_addr : ip = read(src_ip) ;

# ä»å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ—¶é—´
event_time : time = read(timestamp) ;
```

## è¯»å–è¯­ä¹‰ï¼šread vs take

è¿™æ˜¯ OML ä¸­æœ€é‡è¦çš„æ¦‚å¿µä¹‹ä¸€ã€‚

### readï¼šéç ´åæ€§è¯»å–

**ç‰¹æ€§**ï¼š
- ä»æºæ•°æ®**å…‹éš†**å€¼åˆ°ç›®æ ‡
- æºæ•°æ®ä¿æŒä¸å˜
- å¯ä»¥å¤šæ¬¡è¯»å–åŒä¸€å­—æ®µ

**ä½¿ç”¨åœºæ™¯**ï¼š
- å­—æ®µéœ€è¦åœ¨å¤šå¤„ä½¿ç”¨
- éœ€è¦ä¿ç•™åŸå§‹æ•°æ®

**ç¤ºä¾‹**ï¼š
```oml
name : read_example
---
# å‡è®¾è¾“å…¥ï¼šdata = "hello"

field1 = read(data) ;  # field1 = "hello"ï¼Œsrc.data ä»å­˜åœ¨
field2 = read(data) ;  # field2 = "hello"ï¼Œå¯ä»¥å†æ¬¡è¯»å–
field3 = read(data) ;  # field3 = "hello"ï¼Œä»ç„¶å¯ä»¥è¯»å–
```

### takeï¼šç ´åæ€§è¯»å–

**ç‰¹æ€§**ï¼š
- ä»æºæ•°æ®**ç§»èµ°**å€¼åˆ°ç›®æ ‡
- æºæ•°æ®ä¸­è¯¥å­—æ®µè¢«åˆ é™¤
- åªèƒ½è¯»å–ä¸€æ¬¡

**ä½¿ç”¨åœºæ™¯**ï¼š
- å­—æ®µåªéœ€è¦ä½¿ç”¨ä¸€æ¬¡
- éœ€è¦ç¡®ä¿å­—æ®µä¸è¢«é‡å¤ä½¿ç”¨
- ä¼˜åŒ–æ€§èƒ½ï¼ˆé¿å…æ•°æ®å¤åˆ¶ï¼‰

**ç¤ºä¾‹**ï¼š
```oml
name : take_example
---
# å‡è®¾è¾“å…¥ï¼šdata = "hello"

field1 = take(data) ;  # field1 = "hello"ï¼Œsrc.data è¢«ç§»é™¤
field2 = take(data) ;  # å¤±è´¥ï¼data å·²ç»ä¸å­˜åœ¨
```

### è¯»å–ä¼˜å…ˆçº§

`read` å’Œ `take` éƒ½éµå¾ªä»¥ä¸‹æŸ¥æ‰¾é¡ºåºï¼š

1. å…ˆæŸ¥æ‰¾**ç›®æ ‡è®°å½•**ï¼ˆdstï¼‰
2. å¦‚æœæœªæ‰¾åˆ°ï¼Œå†æŸ¥æ‰¾**æºè®°å½•**ï¼ˆsrcï¼‰

```oml
name : lookup_priority
---
# å‡è®¾ï¼šsrc.value = "A"

field1 = read(value) ;     # "A" (ä» src è¯»å–)
field2 = read(field1) ;    # "A" (ä» dst è¯»å–ï¼Œfield1 å·²åœ¨ç›®æ ‡ä¸­)
```

## è¡¨è¾¾å¼ç±»å‹

### å€¼è¡¨è¾¾å¼

ç›´æ¥æ„é€ å¸¸é‡å€¼ï¼š

```oml
name : value_expr
---
# å­—ç¬¦ä¸²
text = chars(hello) ;

# æ•´æ•°
count = digit(100) ;

# IP
ip_addr = ip(192.168.1.1) ;
```

### å‡½æ•°è°ƒç”¨

è°ƒç”¨å†…ç½®å‡½æ•°ï¼š

```oml
name : function_call
---
# æ—¶é—´å‡½æ•°
now = Now::time() ;
today = Now::date() ;
hour = Now::hour() ;
```

### ç®¡é“è¡¨è¾¾å¼

é“¾å¼å¤„ç†æ•°æ®ï¼š

```oml
name : pipe_expr
---
# è¯»å– â†’ è½¬ JSON â†’ Base64 ç¼–ç 
encoded = pipe read(data) | to_json | base64_encode ;

# ä¹Ÿå¯ä»¥çœç•¥ pipe å…³é”®å­—
encoded2 = read(data) | to_json | base64_encode ;
```

### æ¡ä»¶è¡¨è¾¾å¼

åŸºäºæ¡ä»¶é€‰æ‹©å€¼ï¼š

```oml
name : match_expr
---
level = match read(status) {
    in (digit(200), digit(299)) => chars(success) ;
    in (digit(400), digit(499)) => chars(error) ;
    _ => chars(other) ;
} ;
```

### èšåˆè¡¨è¾¾å¼

åˆ›å»ºå¤åˆæ•°æ®ç»“æ„ï¼š

```oml
name : aggregate_expr
---
# å¯¹è±¡èšåˆ
info : obj = object {
    name = read(name) ;
    age = read(age) ;
} ;

# æ•°ç»„èšåˆ
items : array = collect read(keys:[a, b, c]) ;
```

## é»˜è®¤å€¼æœºåˆ¶

### é»˜è®¤å€¼è¯­æ³•

å½“å­—æ®µä¸å­˜åœ¨æˆ–è¯»å–å¤±è´¥æ—¶ï¼Œä½¿ç”¨é»˜è®¤å€¼ï¼š

```oml
name : default_value
---
# è¯­æ³•ï¼šread(...) { _ : <é»˜è®¤å€¼> }
country = read(country) { _ : chars(CN) } ;
version = read(version) { _ : chars(1.0.0) } ;
port = read(port) { _ : digit(8080) } ;
```

### é»˜è®¤å€¼å¯ä»¥æ˜¯å‡½æ•°è°ƒç”¨

```oml
name : default_with_function
---
# å¦‚æœ timestamp ä¸å­˜åœ¨ï¼Œä½¿ç”¨å½“å‰æ—¶é—´
event_time = read(timestamp) { _ : Now::time() } ;
```

### é»˜è®¤å€¼å¯ä»¥æ˜¯è¯»å–

```oml
name : default_with_read
---
# å¦‚æœ id ä¸å­˜åœ¨ï¼Œå°è¯•è¯»å– user_id
user_id = read(id) { _ : read(user_id) } ;
```

### é™åˆ¶

- `@ref` è¯­æ³•ç³–ä¸æ”¯æŒé»˜è®¤å€¼
- é»˜è®¤å€¼è¡¨è¾¾å¼ä¸èƒ½æ˜¯ `match`ã€`object`ã€`collect` ç­‰å¤æ‚è¡¨è¾¾å¼

## é€šé…ç¬¦ä¸æ‰¹é‡å¤„ç†

### é€šé…ç¬¦è¯­æ³•

ä½¿ç”¨ `*` åŒ¹é…å¤šä¸ªå­—æ®µï¼š

```oml
name : wildcard
---
# æ”¶é›†æ‰€æœ‰ä»¥ cpu_ å¼€å¤´çš„å­—æ®µ
cpu_metrics = collect read(keys:[cpu_*]) ;

# æ”¶é›†æ‰€æœ‰ä»¥ /path ç»“å°¾çš„å­—æ®µ
paths = collect read(keys:[*/path]) ;
```

### æ‰¹é‡ç›®æ ‡

ç›®æ ‡å­—æ®µååŒ…å« `*` æ—¶è¿›å…¥æ‰¹é‡æ¨¡å¼ï¼š

```oml
name : batch_target
---
# å–èµ°æ‰€æœ‰å­—æ®µ
* = take() ;

# å–èµ°æ‰€æœ‰ä»¥ alert_ å¼€å¤´çš„å­—æ®µ
alert* = take() ;

# å–èµ°æ‰€æœ‰ä»¥ _log ç»“å°¾çš„å­—æ®µ
*_log = take() ;
```

**é™åˆ¶**ï¼šæ‰¹é‡æ¨¡å¼åªæ”¯æŒ `read` å’Œ `take`ï¼Œä¸æ”¯æŒå…¶ä»–è¡¨è¾¾å¼ã€‚

## å‚æ•°åŒ–è¯»å–

### optionï¼šæŒ‰ä¼˜å…ˆçº§å°è¯•

```oml
name : option_param
---
# æŒ‰é¡ºåºå°è¯•è¯»å– idã€uidã€user_id
user_id = read(option:[id, uid, user_id]) ;
```

**è¡Œä¸º**ï¼š
- ä»å·¦åˆ°å³å°è¯•æ¯ä¸ªå­—æ®µ
- è¿”å›ç¬¬ä¸€ä¸ªå­˜åœ¨çš„å­—æ®µå€¼
- å¦‚æœéƒ½ä¸å­˜åœ¨ï¼Œè¿”å›å¤±è´¥ï¼ˆå¯é…åˆé»˜è®¤å€¼ï¼‰

### keysï¼šæ”¶é›†å¤šä¸ªå­—æ®µ

```oml
name : keys_param
---
# æ”¶é›†å¤šä¸ªå­—æ®µä¸ºæ•°ç»„
ports = collect read(keys:[sport, dport]) ;
```

**è¡Œä¸º**ï¼š
- è¯»å–æ‰€æœ‰æŒ‡å®šçš„å­—æ®µ
- æ”¯æŒé€šé…ç¬¦ `*`
- è¿”å›æ•°ç»„

### JSON è·¯å¾„

è¯»å–åµŒå¥—æ•°æ®ï¼š

```oml
name : json_path
---
# è¯»å– /user/info/name
username = read(/user/info/name) ;

# è¯»å–æ•°ç»„å…ƒç´  /items[0]/id
first_id = read(/items[0]/id) ;
```

## è¡¨è¾¾å¼ç»„åˆ

### åµŒå¥—å¯¹è±¡

```oml
name : nested_objects
---
deployment : obj = object {
    app : obj = object {
        name = read(app_name) ;
        version = read(app_version) ;
    } ;
    env : obj = object {
        region = read(region) ;
        zone = read(zone) ;
    } ;
} ;
```

### ç®¡é“é“¾

```oml
name : pipe_chain
---
# å¤šçº§è½¬æ¢
result = read(data) | to_json | base64_encode | html_escape ;

# æ•°ç»„æ“ä½œ
first_user = read(users) | nth(0) | get(name) ;
```

### match ä¸­çš„å¤æ‚è¡¨è¾¾å¼

```oml
name : complex_match
---
status = match read(code) {
    in (digit(200), digit(299)) => collect read(keys:[a, b]) ;
    _ => read(default_value) ;
} ;
```

## ä½œç”¨åŸŸè§„åˆ™

### ç›®æ ‡å­—æ®µä½œç”¨åŸŸ

åœ¨ `object` å†…éƒ¨åˆ›å»ºçš„å­—æ®µï¼Œåªåœ¨å¯¹è±¡å†…å¯è§ï¼š

```oml
name : scope_example
---
info : obj = object {
    name = read(username) ;  # name åªåœ¨ info å¯¹è±¡å†…
} ;

# è¿™é‡Œæ— æ³•è®¿é—® name
other = read(name) ;  # å¤±è´¥ï¼name ä¸åœ¨å¤–éƒ¨ä½œç”¨åŸŸ
```

### å…¨å±€ç›®æ ‡å­—æ®µ

é¡¶å±‚å®šä¹‰çš„å­—æ®µå¯ä»¥è¢«åç»­è¯»å–ï¼š

```oml
name : global_scope
---
# å®šä¹‰å…¨å±€å­—æ®µ
temp = read(data) ;

# åç»­å¯ä»¥è¯»å–
result = read(temp) ;
```

## æ˜“é”™æé†’

1. **åˆ†å·å¿…éœ€**ï¼šæ¯ä¸ªé¡¶å±‚æ¡ç›®å¿…é¡»ä»¥ `;` ç»“æŸ
2. **ç±»å‹ä¸åŒ¹é…**ï¼šæ˜¾å¼ç±»å‹å£°æ˜ä¸å®é™…å€¼ä¸ç¬¦ä¼šå¯¼è‡´è½¬æ¢é”™è¯¯
3. **take åå†è¯»**ï¼šä½¿ç”¨ `take` åè¯¥å­—æ®µè¢«ç§»é™¤ï¼Œæ— æ³•å†æ¬¡è¯»å–
4. **@ref é™åˆ¶**ï¼š`@ref` åªèƒ½åœ¨ç‰¹å®šä½ç½®ä½¿ç”¨ï¼Œä¸æ”¯æŒé»˜è®¤å€¼
5. **æ‰¹é‡æ¨¡å¼é™åˆ¶**ï¼šç›®æ ‡åå« `*` æ—¶ï¼Œå³å€¼åªèƒ½æ˜¯ `read` æˆ– `take`

## æœ€ä½³å®è·µ

### 1. é€‰æ‹©åˆé€‚çš„è¯»å–æ¨¡å¼

```oml
# æ¨èï¼šå­—æ®µå¤ç”¨æ—¶ç”¨ read
temp = read(data) ;
result1 = pipe read(temp) | to_json ;
result2 = pipe read(temp) | base64_encode ;

# æ¨èï¼šä¸€æ¬¡æ€§ä½¿ç”¨æ—¶ç”¨ take
final = take(data) | to_json ;
```

### 2. æ˜¾å¼ç±»å‹å£°æ˜

```oml
# æ¨èï¼šæ˜ç¡®ç±»å‹
port : digit = read(port) ;
ip_addr : ip = read(src_ip) ;

# å¯æ¥å—ï¼šç®€å•åœºæ™¯è‡ªåŠ¨æ¨æ–­
name = read(name) ;
```

### 3. æä¾›é»˜è®¤å€¼

```oml
# æ¨èï¼šå…³é”®å­—æ®µæä¾›é»˜è®¤å€¼
version = read(version) { _ : chars(1.0.0) } ;
timeout = read(timeout) { _ : digit(30) } ;
```

### 4. åˆç†ä½¿ç”¨é€šé…ç¬¦

```oml
# æ¨èï¼šæ˜ç¡®çš„é€šé…ç¬¦æ¨¡å¼
cpu_metrics = collect read(keys:[cpu_*]) ;

# é¿å…ï¼šè¿‡äºå®½æ³›çš„é€šé…ç¬¦
all = collect read(keys:[*]) ;  # å¯èƒ½åŒ…å«ä¸éœ€è¦çš„å­—æ®µ
```

## ä¸‹ä¸€æ­¥

- [å®æˆ˜æŒ‡å—](./03-practical-guide.md) - æŒ‰ä»»åŠ¡æŸ¥æ‰¾è§£å†³æ–¹æ¡ˆ
- [å‡½æ•°å‚è€ƒ](./04-functions-reference.md) - æŸ¥é˜…æ‰€æœ‰å¯ç”¨å‡½æ•°
- [å¿«é€Ÿå…¥é—¨](./01-quickstart.md) - å›é¡¾åŸºç¡€ç”¨æ³•
- [è¯­æ³•å‚è€ƒ](./06-grammar-reference.md) - æŸ¥çœ‹å®Œæ•´è¯­æ³•å®šä¹‰
