# WPL å¿«é€Ÿå…¥é—¨

5 åˆ†é’Ÿä¸Šæ‰‹ WPLï¼Œç«‹å³è§£æä½ çš„æ—¥å¿—æ•°æ®ã€‚

---

## ğŸ“š å¿«é€Ÿå¯¼èˆª

| ä¸»é¢˜ | å†…å®¹ |
|------|------|
| [**ä»€ä¹ˆæ˜¯ WPL**](#ä»€ä¹ˆæ˜¯-wpl) | WPL ç®€ä»‹ã€æ ¸å¿ƒç‰¹ç‚¹ã€é€‚ç”¨åœºæ™¯ |
| [**å®Œæ•´ç±»å‹ç³»ç»Ÿ**](#-å®Œæ•´ç±»å‹ç³»ç»Ÿ) | 23 ç§æ•°æ®ç±»å‹æ€»è§ˆ |
| [**æœ€ç®€ç¤ºä¾‹**](#æœ€ç®€ç¤ºä¾‹nginx-æ—¥å¿—) | Nginx æ—¥å¿—è§£æ |
| [**3 ä¸ªæœ€å¸¸ç”¨åœºæ™¯**](#3-ä¸ªæœ€å¸¸ç”¨åœºæ™¯) | ç©ºæ ¼åˆ†éš”ã€JSONã€KV é”®å€¼å¯¹ |
| [**åŸºæœ¬è¯­æ³•é€Ÿè§ˆ**](#åŸºæœ¬è¯­æ³•é€Ÿè§ˆ) | ç»“æ„ã€ç±»å‹ã€åŒ¹é…æ¨¡å¼ |
| [**å¸¸è§æ¨¡å¼é€ŸæŸ¥**](#å¸¸è§æ¨¡å¼é€ŸæŸ¥) | å¼•å·å­—æ®µã€å¯é€‰å­—æ®µã€é‡å¤å­—æ®µç­‰ |
| [**å¿«é€Ÿè°ƒè¯•æŠ€å·§**](#å¿«é€Ÿè°ƒè¯•æŠ€å·§) | è°ƒè¯•æ–¹æ³• |
| [**å®æˆ˜ç»ƒä¹ **](#å®æˆ˜ç»ƒä¹ ) | 3 ä¸ªç»ƒä¹ é¢˜ |

---

## ä»€ä¹ˆæ˜¯ WPL

WPL (Warp Processing Language) æ˜¯ä¸€ç§**å£°æ˜å¼è§„åˆ™è¯­è¨€**ï¼Œç”¨äºæè¿°å¦‚ä½•ä»æ—¥å¿—ã€æ¶ˆæ¯ç­‰æ–‡æœ¬æ•°æ®ä¸­**æå–å­—æ®µ**å’Œ**è§£æç»“æ„**ã€‚

### æ ¸å¿ƒç‰¹ç‚¹

- **å£°æ˜å¼**ï¼šæè¿°"æ•°æ®æ˜¯ä»€ä¹ˆ"ï¼Œè€Œé"å¦‚ä½•æå–"
- **ç±»å‹å®‰å…¨**ï¼šè‡ªåŠ¨éªŒè¯å’Œè½¬æ¢ï¼ˆIPã€æ—¶é—´ã€JSON ç­‰ 37 ç§ç±»å‹ï¼‰
- **å¼ºå¤§çµæ´»**ï¼šæ”¯æŒ JSON/KV åµŒå¥—æå–ã€Base64 è§£ç ã€å­—æ®µéªŒè¯ç­‰
- **æ˜“äºå­¦ä¹ **ï¼š5 åˆ†é’Ÿå³å¯ä¸Šæ‰‹åŸºç¡€ç”¨æ³•

### é€‚ç”¨åœºæ™¯

- è§£æ Web æœåŠ¡å™¨æ—¥å¿—ï¼ˆNginxã€Apacheï¼‰
- æå– JSON/KV ç»“æ„åŒ–æ•°æ®
- å¤„ç†ç¼–ç æ•°æ®ï¼ˆBase64ã€Hexï¼‰
- é˜²ç«å¢™ã€å®‰å…¨è®¾å¤‡æ—¥å¿—è§£æ
- è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼è§£æ

---

## ğŸ“š å®Œæ•´ç±»å‹ç³»ç»Ÿ

**WPL æ”¯æŒ 23 ç§ä¸»è¦æ•°æ®ç±»å‹**ï¼Œæ¶µç›–åŸºç¡€ç±»å‹ã€æ—¶é—´ã€ç½‘ç»œã€ç»“æ„åŒ–æ•°æ®ã€åè®®å’Œç¼–ç ç­‰ã€‚

ğŸ‘‰ **æŸ¥çœ‹å®Œæ•´ç¤ºä¾‹ï¼š** [07-complete-types-example.md](./07-complete-types-example.md)

è¯¥æ–‡æ¡£åŒ…å«ï¼š
- âœ… æ‰€æœ‰ 23 ç§ç±»å‹çš„å®Œæ•´ç¤ºä¾‹ä»£ç 
- âœ… å¯è¿è¡Œçš„è¾“å…¥æ•°æ®å’Œ WPL è§„åˆ™
- âœ… æ¯ç§ç±»å‹çš„è¯¦ç»†è¯´æ˜å’Œä½¿ç”¨å»ºè®®
- âœ… å¸¸è§ç±»å‹ç»„åˆæ¨¡å¼

**å¿«é€Ÿé¢„è§ˆä¸»è¦ç±»å‹ï¼š**
- **åŸºç¡€**ï¼š`digit`ã€`float`ã€`chars`ã€`bool`
- **æ—¶é—´**ï¼š`time/clf`ã€`time_3339`ã€`time_2822`ã€`time_timestamp`
- **ç½‘ç»œ**ï¼š`ip`ã€`ip_net`ã€`port`ã€`domain`ã€`url`
- **ç»“æ„åŒ–**ï¼š`json`ã€`kvarr`ã€`array`
- **åè®®**ï¼š`http/request`ã€`http/status`ã€`http/method`ã€`http/agent`
- **ç¼–ç **ï¼š`hex`ã€`base64`

---

## æœ€ç®€ç¤ºä¾‹ï¼šNginx æ—¥å¿—

**è¾“å…¥æ•°æ®ï¼š**
```
192.168.1.2 - - [06/Aug/2019:12:12:19 +0800] "GET /index.html HTTP/1.1" 200 1024
```

**WPL è§„åˆ™ï¼š**
```wpl
package nginx {
  rule access_log {
    (
      ip:client_ip,
      2*_,
      time/clf<[,]>:time,
      http/request":request,
      digit:status,
      digit:bytes
    )
  }
}
```

**è¾“å‡ºç»“æœï¼š**
```
client_ip: 192.168.1.2
time: 2019-08-06 12:12:19
request: GET /index.html HTTP/1.1
status: 200
bytes: 1024
```

**è¯´æ˜ï¼š**
- `ip:client_ip` - æå– IP åœ°å€ï¼Œå‘½åä¸º client_ip
- `2*_` - å¿½ç•¥ 2 ä¸ªå­—æ®µï¼ˆä¸¤ä¸ª `-`ï¼‰
- `time/clf<[,]>` - æå–æ–¹æ‹¬å·åŒ…è£¹çš„ CLF æ—¶é—´
- `http/request"` - æå–å¼•å·åŒ…è£¹çš„ HTTP è¯·æ±‚
- `digit` - æå–æ•°å­—

---

## 3 ä¸ªæœ€å¸¸ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šç©ºæ ¼åˆ†éš”çš„æ—¥å¿—

**è¾“å…¥ï¼š**
```
200 192.168.1.1 2023-01-01T12:00:00 login_success
```

**WPLï¼š**
```wpl
package demo {
  rule simple_log {
    (digit:code, ip:client, time:ts, chars:action)
  }
}
```

**è¾“å‡ºï¼š**
```
code: 200
client: 192.168.1.1
ts: 2023-01-01 12:00:00
action: login_success
```

---

### åœºæ™¯ 2ï¼šJSON æ•°æ®

**è¾“å…¥ï¼š**
```json
{"user":"admin","code":200,"message":"success"}
```

**WPLï¼š**
```wpl
package api {
  rule json_response {
    (json(
      chars@user,
      digit@code,
      chars@message
    ))
  }
}
```

**è¾“å‡ºï¼š**
```
user: admin
code: 200
message: success
```

---

### åœºæ™¯ 3ï¼šKV é”®å€¼å¯¹

**è¾“å…¥ï¼š**
```
host=server1;port=8080;user=admin;status=online
```

**WPLï¼š**
```wpl
package config {
  rule kv_log {
    (kvarr)
  }
}
```

**è¾“å‡ºï¼š**
```
host: server1
port: 8080
user: admin
status: online
```

---

## åŸºæœ¬è¯­æ³•é€Ÿè§ˆ

### ç»“æ„

```wpl
package åŒ…å {
  rule è§„åˆ™å {
    (å­—æ®µåˆ—è¡¨)
  }
}
```

### å¸¸ç”¨å­—æ®µç±»å‹

| ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `digit` | æ•´æ•° | `200`, `8080` |
| `chars` | å­—ç¬¦ä¸² | `"hello"`, `admin` |
| `ip` | IP åœ°å€ | `192.168.1.1` |
| `time` | æ—¶é—´ | `2023-01-01 12:00:00` |
| `time/clf` | CLF æ—¶é—´ | `[06/Aug/2019:12:12:19 +0800]` |
| `json` | JSON å¯¹è±¡ | `{"key":"value"}` |
| `kv` | é”®å€¼å¯¹ | `key=value` |
| `http/request` | HTTP è¯·æ±‚ | `GET /path HTTP/1.1` |
| `http/status` | HTTP çŠ¶æ€ç  | `200` |

### å­—æ®µå‘½å

```wpl
type:name              # å‘½åå­—æ®µ
digit:status           # status = æ•°å­—
ip:client_ip           # client_ip = IPåœ°å€
```

### å¿½ç•¥å­—æ®µ

```wpl
_                      # å¿½ç•¥ 1 ä¸ªå­—æ®µ
2*_                    # å¿½ç•¥ 2 ä¸ªå­—æ®µ
5*_                    # å¿½ç•¥ 5 ä¸ªå­—æ®µ
```

### æ ¼å¼æ§åˆ¶

```wpl
<[,]>                  # æ–¹æ‹¬å·åŒ…è£¹ï¼š[content]
<{,}>                  # èŠ±æ‹¬å·åŒ…è£¹ï¼š{content}
"                      # å¼•å·åŒ…è£¹ï¼š"content"
^N                     # å›ºå®š N ä¸ªå­—ç¬¦
```

### é‡å¤æ¨¡å¼

```wpl
kvarr                  # è‡ªåŠ¨è§£ææ‰€æœ‰KV
3*ip                   # é‡å¤ 3 æ¬¡
12*digit               # é‡å¤ 12 æ¬¡
```

### å­å­—æ®µæå–

```wpl
# JSON å­å­—æ®µ
json(chars@name, digit@age)

# KV å­å­—æ®µ
kvarr(chars@host, digit@port)

# åµŒå¥—å­—æ®µ
json(chars@user/name, digit@user/age)
```

---

## å¸¸è§æ¨¡å¼é€ŸæŸ¥

### è§£æå¸¦å¼•å·çš„å­—æ®µ

```wpl
chars":url             # "http://example.com"
http/agent":ua         # "Mozilla/5.0..."
```

### è§£æå¸¦ç‰¹æ®Šåˆ†éš”ç¬¦çš„æ•°æ®

```wpl
# é€—å·åˆ†éš”
(digit, ip, chars)\,

# åˆ†å·åˆ†éš”
(digit, ip, chars)\;

# å­—æ®µçº§åˆ†éš”ç¬¦ï¼ˆä¼˜å…ˆçº§æ›´é«˜ï¼‰
digit\,, ip\;, chars\s
```

### å¯é€‰å­—æ®µ

```wpl
opt(chars)             # å¯é€‰å­—æ®µ
(digit, opt(chars), time)
```

### Base64 è§£ç 

```wpl
|decode/base64|
(json(chars@data))
```

---

## å¿«é€Ÿè°ƒè¯•æŠ€å·§

### 1. ä»ç®€å•å¼€å§‹

```wpl
# ç¬¬ 1 æ­¥ï¼šæœ€ç®€å•
(digit)

# ç¬¬ 2 æ­¥ï¼šæ·»åŠ å­—æ®µ
(digit, ip)

# ç¬¬ 3 æ­¥ï¼šæ·»åŠ å‘½å
(digit:status, ip:client)

# ç¬¬ 4 æ­¥ï¼šæ·»åŠ å¤æ‚ç±»å‹
(digit:status, ip:client, json(chars@name))
```

### 2. ä½¿ç”¨ opt() å®šä½é—®é¢˜

```wpl
# å¦‚æœæŸä¸ªå­—æ®µå¯¼è‡´å¤±è´¥ï¼Œç”¨ opt åŒ…è£¹
(digit, opt(ip), time, chars)
# å¦‚æœ ip è§£æå¤±è´¥ï¼Œå…¶ä»–å­—æ®µä»ç„¶å¯ä»¥è§£æ
```

### 3. æ£€æŸ¥åˆ†éš”ç¬¦

æ‰“å°åŸå§‹æ•°æ®ï¼Œç¡®è®¤å­—æ®µé—´çš„åˆ†éš”ç¬¦ï¼š
```
æ•°æ®ï¼š200,192.168.1.1,admin
åˆ†éš”ç¬¦ï¼šé€—å·
è§„åˆ™ï¼š(digit, ip, chars)\,
```

---

## ä¸‹ä¸€æ­¥

### ç†è§£æ¦‚å¿µ
â†’ [02-core-concepts.md](./02-core-concepts.md) - ç†è§£ WPL çš„è®¾è®¡ç†å¿µ

**ä½ å°†å­¦åˆ°ï¼š**
- ä¸ºä»€ä¹ˆ WPL è¿™æ ·è®¾è®¡ï¼Ÿ
- ç±»å‹ç³»ç»Ÿçš„ä½œç”¨
- åŒ¹é…è¯­ä¹‰ï¼ˆseq/alt/opt/some_ofï¼‰
- ç®¡é“ç³»ç»ŸåŸç†
- åˆ†éš”ç¬¦ä¼˜å…ˆçº§

---

### è§£å†³å®é™…é—®é¢˜
â†’ [03-practical-guide.md](./03-practical-guide.md) - æŒ‰ä»»åŠ¡æŸ¥æ‰¾è§£å†³æ–¹æ¡ˆ

**ä½ å°†å­¦åˆ°ï¼š**
- è§£æ Web æœåŠ¡å™¨æ—¥å¿—ï¼ˆNginx/Apacheï¼‰
- è§£æ JSON æ•°æ®ï¼ˆåµŒå¥—ã€åè½¬ä¹‰ï¼‰
- è§£æ KV é”®å€¼å¯¹ï¼ˆå¤šç§åˆ†éš”ç¬¦ï¼‰
- å¤„ç†ç¼–ç æ•°æ®ï¼ˆBase64/Hexï¼‰
- å­—æ®µéªŒè¯ä¸è¿‡æ»¤
- å¤æ‚åœºæ™¯ï¼ˆé‡å¤æ¨¡å¼ã€å¯é€‰å­—æ®µï¼‰

---

### æŸ¥é˜…å‚è€ƒ
â†’ [04-language-reference.md](./04-language-reference.md) - å®Œæ•´ç±»å‹å’Œè¯­æ³•å‚è€ƒ
â†’ [05-functions-reference.md](./05-functions-reference.md) - æ‰€æœ‰å‡½æ•°å‚è€ƒ

---

## å®æˆ˜ç»ƒä¹ 

### ç»ƒä¹  1ï¼šè§£æè‡ªå®šä¹‰æ—¥å¿—

**æ•°æ®ï¼š**
```
[2023-01-01 12:00:00] INFO 192.168.1.1 user=admin action=login
```

**æç¤ºï¼š**
- æ—¶é—´åœ¨æ–¹æ‹¬å·ä¸­
- INFO å¯ä»¥å¿½ç•¥
- åé¢æ˜¯ IP å’Œ KV

<details>
<summary>æŸ¥çœ‹ç­”æ¡ˆ</summary>

```wpl
package practice {
  rule custom_log {
    (
      time<[,]>:timestamp,
      _,
      ip:client,
      kvarr
    )
  }
}
```
</details>

---

### ç»ƒä¹  2ï¼šè§£æåµŒå¥— JSON

**æ•°æ®ï¼š**
```json
{"user":{"name":"Alice","age":25},"status":"active"}
```

**æç¤ºï¼š**
- ä½¿ç”¨ @path/to/field æå–åµŒå¥—å­—æ®µ

<details>
<summary>æŸ¥çœ‹ç­”æ¡ˆ</summary>

```wpl
package practice {
  rule nested_json {
    (json(
      chars@user/name,
      digit@user/age,
      chars@status
    ))
  }
}
```
</details>

---

### ç»ƒä¹  3ï¼šè§£æ Base64 ç¼–ç æ—¥å¿—

**æ•°æ®ï¼ˆBase64ï¼‰ï¼š**
```
eyJ1c2VyIjoiYWRtaW4iLCJjb2RlIjoyMDB9
```

**è§£ç åï¼š**
```json
{"user":"admin","code":200}
```

**æç¤ºï¼š**
- ä½¿ç”¨ `|decode/base64|` é¢„å¤„ç†

<details>
<summary>æŸ¥çœ‹ç­”æ¡ˆ</summary>

```wpl
package practice {
  rule base64_log {
    |decode/base64|
    (json(
      chars@user,
      digit@code
    ))
  }
}
```
</details>

---

## ç›¸å…³èµ„æº

- æ ¸å¿ƒæ¦‚å¿µï¼š[02-core-concepts.md](./02-core-concepts.md)
- å®æˆ˜æŒ‡å—ï¼š[03-practical-guide.md](./03-practical-guide.md)
- è¯­è¨€å‚è€ƒï¼š[04-language-reference.md](./04-language-reference.md)
- å‡½æ•°å‚è€ƒï¼š[05-functions-reference.md](./05-functions-reference.md)
- è¯­æ³•è§„èŒƒï¼š[06-grammar-reference.md](./06-grammar-reference.md)
