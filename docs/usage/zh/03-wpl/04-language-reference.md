# WPL è¯­è¨€å‚è€ƒ

æœ¬æ–‡æ¡£æä¾› WPL çš„å®Œæ•´è¯­è¨€å…ƒç´ å‚è€ƒï¼Œç”¨äºå¿«é€ŸæŸ¥é˜…ç±»å‹ã€è¯­æ³•å’Œç»“æ„ã€‚

---

## ğŸ“‘ æ–‡æ¡£å¯¼èˆª

| ç« èŠ‚ | è¯´æ˜ |
|------|------|
| [ç±»å‹ç³»ç»Ÿ](#-ç±»å‹ç³»ç»Ÿ) | æ‰€æœ‰æ•°æ®ç±»å‹é€ŸæŸ¥è¡¨ |
| [è¯­æ³•å…ƒç´ ](#-è¯­æ³•å…ƒç´ ) | åŸºæœ¬ç»“æ„ã€å­—æ®µå®šä¹‰ã€æ ¼å¼æ§åˆ¶ |
| [å­å­—æ®µè¯­æ³•](#-å­å­—æ®µè¯­æ³•) | JSONã€KVã€æ•°ç»„å­å­—æ®µ |
| [æ³¨è§£](#-æ³¨è§£) | tagã€copy_raw æ³¨è§£ |
| [è¯­æ³•é€ŸæŸ¥](#-è¯­æ³•é€ŸæŸ¥) | å¸¸ç”¨æ¨¡å¼å¿«é€Ÿå‚è€ƒ |

---

## ğŸ“‹ ç±»å‹ç³»ç»Ÿ

### åŸºç¡€ç±»å‹

| # | ç±»å‹ | æ ‡è¯†ç¬¦ | æ ·ä¾‹ | è¯´æ˜ |
|---|------|--------|------|------|
| 1 | é¢„è¯»ç¬¦å· | `peek_symbol(xxx)` | `peek_symbol(GET)` | é¢„è¯»ä½†ä¸æ¶ˆè´¹ |
| 2 | å¿½ç•¥ | `_` | `_`, `2*_`, `3*_` | å¿½ç•¥è¯¥å­—æ®µ |
| 3 | ç¬¦å· | `symbol(xxx)` | `symbol(HTTP)` | ç²¾ç¡®åŒ¹é… |
| 4 | å¸ƒå°” | `bool` | `true`, `false` | å¸ƒå°”å€¼ |
| 5 | å­—ç¬¦ä¸² | `chars` | `"hello"` | ä»»æ„å­—ç¬¦ä¸² |
| 6 | æ•´æ•° | `digit` | `123`, `8080` | æ•´æ•° |
| 7 | æµ®ç‚¹ | `float` | `3.14`, `0.01` | æµ®ç‚¹æ•° |
| 8 | åºåˆ—å· | `sn` | `ABC123XYZ` | è‡ªåŠ¨ç”Ÿæˆåºåˆ—å· |

### æ—¶é—´ç±»å‹

| # | ç±»å‹ | æ ‡è¯†ç¬¦ | æ ·ä¾‹ | è¯´æ˜ |
|---|------|--------|------|------|
| 9 | é€šç”¨æ—¶é—´ | `time` | `2023-05-15 07:09:12` | è‡ªåŠ¨è¯†åˆ«å¤šç§æ ¼å¼ |
| 10 | ISO 8601 | `time_iso` | `2023-05-15T07:09:12Z` | ISO 8601 æ ‡å‡† |
| 11 | RFC 3339 | `time_3339` | `2022-03-21T12:34:56+00:00` | RFC3339 æ ‡å‡† |
| 12 | RFC 2822 | `time_2822` | `Mon, 07 Jul 2025 09:20:32 +0000` | é‚®ä»¶æ—¶é—´æ ¼å¼ |
| 13 | CLF æ—¶é—´ | `time/clf` | `06/Aug/2019:12:12:19 +0800` | Apache/Nginx æ—¥å¿— |
| 14 | Unixæ—¶é—´æˆ³ | `time_timestamp` | `1647849600` | Unix ç§’çº§æ—¶é—´æˆ³ |

### ç½‘ç»œç±»å‹

| # | ç±»å‹ | æ ‡è¯†ç¬¦ | æ ·ä¾‹ | è¯´æ˜ |
|---|------|--------|------|------|
| 15 | IPåœ°å€ | `ip` | `192.168.1.100`, `::1` | IPv4/IPv6 åœ°å€ |
| 16 | IPç½‘æ®µ | `ip_net` | `192.168.0.0/24` | CIDR ç½‘æ®µ |
| 17 | åŸŸå | `domain` | `example.com` | åŸŸå |
| 18 | é‚®ç®± | `email` | `user@example.com` | é‚®ç®±åœ°å€ |
| 19 | ç«¯å£ | `port` | `8080`, `443` | ç«¯å£å· |
| 20 | URL | `url` | `http://example.com/path` | å®Œæ•´ URL |

### ç¼–ç ç±»å‹

| # | ç±»å‹ | æ ‡è¯†ç¬¦ | æ ·ä¾‹ | è¯´æ˜ |
|---|------|--------|------|------|
| 21 | åå…­è¿›åˆ¶ | `hex` | `48656c6c6f` | åå…­è¿›åˆ¶æ•°æ® |
| 22 | Base64 | `base64` | `aGVsbG8=` | Base64 ç¼–ç  |

### ç»“æ„åŒ–ç±»å‹

| # | ç±»å‹ | æ ‡è¯†ç¬¦ | æ ·ä¾‹ | è¯´æ˜ |
|---|------|--------|------|------|
| 23 | é”®å€¼å¯¹ | `kvarr` | `key=value` | KV æ ¼å¼ |
| 24 | JSON | `json` | `{"k":"v"}` | JSON å¯¹è±¡ |
| 25 | ä¸¥æ ¼JSON | `exact_json` | `{"k":"v"}` | ä¸¥æ ¼éªŒè¯ JSON |
| 26 | å¯¹è±¡ | `obj` | åµŒå¥—å¯¹è±¡ | é€šç”¨å¯¹è±¡ |
| 27 | æ•°ç»„ | `array` | `[1,2,3]` | æ•°ç»„ |
| 28 | æ•°å­—æ•°ç»„ | `array/digit` | `[1,2,3]` | æ•°å­—æ•°ç»„ |
| 29 | å­—ç¬¦ä¸²æ•°ç»„ | `array/chars` | `["a","b"]` | å­—ç¬¦ä¸²æ•°ç»„ |

### åè®®ç±»å‹

| # | ç±»å‹ | æ ‡è¯†ç¬¦ | æ ·ä¾‹ | è¯´æ˜ |
|---|------|--------|------|------|
| 30 | HTTPè¯·æ±‚ | `http/request` | `GET /path HTTP/1.1` | HTTP è¯·æ±‚è¡Œ |
| 31 | HTTPçŠ¶æ€ | `http/status` | `200`, `404` | HTTP çŠ¶æ€ç  |
| 32 | User-Agent | `http/agent` | `Mozilla/5.0...` | æµè§ˆå™¨ UA |
| 33 | HTTPæ–¹æ³• | `http/method` | `GET`, `POST` | HTTP æ–¹æ³• |

### ç‰¹æ®Šç±»å‹

| # | ç±»å‹ | æ ‡è¯†ç¬¦ | æ ·ä¾‹ | è¯´æ˜ |
|---|------|--------|------|------|
| 34 | èº«ä»½è¯ | `id_card` | `110101199001011234` | 18 ä½èº«ä»½è¯ |
| 35 | æ‰‹æœºå· | `mobile_phone` | `13800138000` | 11 ä½æ‰‹æœºå· |
| 36 | åè®®æ–‡æœ¬ | `proto_text` | åè®®æ ¼å¼ | åè®®æ–‡æœ¬è§£æ |
| 37 | è‡ªåŠ¨è¯†åˆ« | `auto` | è‡ªåŠ¨æ¨æ–­ | è‡ªåŠ¨ç±»å‹æ¨æ–­ |

---

## ğŸ”§ è¯­æ³•å…ƒç´ 

### åŸºæœ¬ç»“æ„

```wpl
package åŒ…å {
  rule è§„åˆ™å {
    |é¢„å¤„ç†ç®¡é“|
    (å­—æ®µåˆ—è¡¨)
  }
}
```

### å­—æ®µå®šä¹‰å®Œæ•´è¯­æ³•

```
[N*] DataType [ (symbol) ] [ (subfields) ] [:name] [ [len] ] [ format ] [ sep ] { | pipe }
```

| éƒ¨åˆ† | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `[N*]` | é‡å¤è®¡æ•° | `kvarr`, `3*ip` |
| `DataType` | æ•°æ®ç±»å‹ | `digit`, `ip`, `json` |
| `(symbol)` | ç¬¦å·å†…å®¹ | `symbol(GET)` |
| `(subfields)` | å­å­—æ®µåˆ—è¡¨ | `json(chars@name)` |
| `:name` | å­—æ®µå‘½å | `:status`, `:client_ip` |
| `[len]` | é•¿åº¦é™åˆ¶ | `[100]` |
| `format` | æ ¼å¼æ§åˆ¶ | `<[,]>`, `"`, `^10` |
| `sep` | åˆ†éš”ç¬¦ | `\,`, `\;`, `\0` |
| `\| pipe` | ç®¡é“å‡½æ•° | `\|f_has(name)\|` |

### æ ¼å¼æ§åˆ¶

| æ ¼å¼ | è¯­æ³• | ç¤ºä¾‹ | è¯´æ˜ |
|------|------|------|------|
| èŒƒå›´å®šç•Œ | `<beg,end>` | `<[,]>`, `<{,}>` | èµ·æ­¢ç¬¦å· |
| å¼•å· | `"` | `chars"` | å¼•å·åŒ…è£¹ |
| å­—ç¬¦è®¡æ•° | `N*` | `10*chars`, `5*_` | æŒ‰å­—ç¬¦æ•° |

### åˆ†ç»„å…ƒä¿¡æ¯

| å…ƒä¿¡æ¯ | è¯´æ˜ | ç¤ºä¾‹ | åŒ¹é…è¡Œä¸º |
|--------|------|------|---------|
| `seq` | é¡ºåºåŒ¹é…ï¼ˆé»˜è®¤ï¼‰ | `seq(ip, digit, time)` | æŒ‰é¡ºåºä¾æ¬¡åŒ¹é… |
| `alt` | æ‹©ä¸€åŒ¹é… | `alt(ip, digit)` | åŒ¹é…å…¶ä¸­ä¸€ä¸ª |
| `opt` | å¯é€‰åŒ¹é… | `opt(chars)` | å¤±è´¥ä¸æŠ¥é”™ |
| `some_of` | å°½å¯èƒ½å¤š | `some_of(ip, digit)` | å¾ªç¯åŒ¹é… |

### åˆ†éš”ç¬¦ä¼˜å…ˆçº§

```
å­—æ®µçº§(3) > ç»„çº§(2) > ä¸Šæ¸¸(1)
```

| åˆ†éš”ç¬¦ | å†™æ³• | è¯´æ˜ | ä¼˜å…ˆçº§ |
|--------|------|------|--------|
| é€—å· | `\,` | é€—å·åˆ†éš” | å­—æ®µçº§ (3) |
| åˆ†å· | `\;` | åˆ†å·åˆ†éš” | å­—æ®µçº§ (3) |
| å†’å· | `\:` | å†’å·åˆ†éš” | å­—æ®µçº§ (3) |
| ç©ºæ ¼ | `\s` | ç©ºæ ¼åˆ†éš” | å­—æ®µçº§ (3) |
| è¡Œå°¾ | `\0` | è¯»åˆ°è¡Œå°¾ | å­—æ®µçº§ (3) |
| ç»„åˆ†éš” | `(...)\sep` | ç»„çº§åˆ†éš” | ç»„çº§ (2) |
| é»˜è®¤ | æ—  | ç»§æ‰¿ä¸Šæ¸¸ | ä¸Šæ¸¸ (1) |

---

## ğŸ¯ å­å­—æ®µè¯­æ³•

### JSON å­å­—æ®µ

```wpl
json(type@key, type@key, ...)
```

**ç¤ºä¾‹ï¼š**
```wpl
# åŸºæœ¬æå–
json(chars@name, digit@age)

# åµŒå¥—è·¯å¾„
json(chars@user/name, digit@user/age)

# å¯é€‰å­—æ®µ
json(chars@name, opt(chars)@email)
```

### KV å­å­—æ®µ

```wpl
kvarr(type@key, type@key, ...)
```

**ç¤ºä¾‹ï¼š**
```wpl
kvarr(chars@hostname, digit@port, opt(chars)@user)
```

### æ•°ç»„

```wpl
array[/subtype]
```

**ç¤ºä¾‹ï¼š**
```wpl
array/digit:nums          # [1,2,3]
array/chars:items         # ["a","b"]
array/array/digit         # åµŒå¥—æ•°ç»„
```

---

## ğŸ“ æ³¨è§£

### tag æ³¨è§£

```wpl
#[tag(key1:"value1", key2:"value2")]
package demo {
  rule x { (digit, time) }
}
```

### copy_raw æ³¨è§£

```wpl
#[copy_raw(name:"raw_log")]
rule nginx_log {
  (ip, time, chars)
}
```

### åŸå§‹å­—ç¬¦ä¸²ï¼ˆé¿å…è½¬ä¹‰ï¼‰

```wpl
#[tag(path:r#"C:\Program Files\App"#)]
package demo {
  rule x { (digit) }
}
```

---

## ğŸ’¡ è¯­æ³•é€ŸæŸ¥

### å¸¸ç”¨æ¨¡å¼

```wpl
# å­—æ®µå‘½å
type:name              # digit:status

# å¿½ç•¥å­—æ®µ
_                      # å¿½ç•¥ 1 ä¸ª
N*_                    # å¿½ç•¥ N ä¸ª

# é‡å¤æ¨¡å¼
kvarr                  # è‡ªåŠ¨è§£æKV
N*ip                   # å›ºå®š N æ¬¡

# å¯é€‰å­—æ®µ
opt(chars)             # å•ä¸ªå¯é€‰
opt(kvarr)             # å¯é€‰ KV

# æ ¼å¼æ§åˆ¶
<[,]>                  # æ–¹æ‹¬å·åŒ…è£¹
"                      # å¼•å·åŒ…è£¹
^10                    # å›ºå®š 10 å­—ç¬¦

# åˆ†éš”ç¬¦
\,                     # é€—å·
\;                     # åˆ†å·
\0                     # è¡Œå°¾

# å­å­—æ®µ
json(chars@key)        # JSON å­—æ®µ
kvarr(digit@port)      # KV å­—æ®µ
@path/to/field         # åµŒå¥—è·¯å¾„
```

---

## ç›¸å…³æ–‡æ¡£

- å¿«é€Ÿå…¥é—¨ï¼š[01-quickstart.md](./01-quickstart.md)
- æ ¸å¿ƒæ¦‚å¿µï¼š[02-core-concepts.md](./02-core-concepts.md)
- å®æˆ˜æŒ‡å—ï¼š[03-practical-guide.md](./03-practical-guide.md)
- å‡½æ•°å‚è€ƒï¼š[05-functions-reference.md](./05-functions-reference.md)
- è¯­æ³•è§„èŒƒï¼š[06-grammar-reference.md](./06-grammar-reference.md)
